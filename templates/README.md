# AWS Identity Management - Configuration Repository

> ⚠️ **AUTO-GENERATED REPOSITORY** - This repository contains Terraform configurations that are automatically generated from AWS IAM Identity Center state. Manual edits will be overwritten on the next generation cycle.

## Overview

This repository contains **generated Terraform configurations** for managing AWS IAM Identity Center (formerly AWS SSO) resources. The Terraform code in this repository is automatically generated by the [aws-identity-management-generator](https://github.com/{{ github_owner }}/{{ generator_repo_name }}) repository.

### What's in This Repository

- **Generated Terraform files** (`.tf` files) for all IAM Identity Center resources
- **Provider configurations** for Terraform Cloud workspaces
- **Inline policies** and **policy JSON files** for permission sets and managed policies
- **Subdirectories** organized by resource type:
  - `identity_store/` - Users, groups, and group memberships
  - `permission_sets/` - Permission sets with inline and managed policies
  - `account_assignments/` - User and group assignments to AWS accounts
  - `managed_policies/` - AWS managed policies
  - `team/` - AWS TEAM (Temporary Elevated Access Management) resources (if enabled)

### What's NOT in This Repository

- **Generator scripts** - Located in the generator repository
- **Jinja2 templates** - Located in the generator repository
- **Infrastructure module** - Located in the generator repository
- **GitHub Actions workflow** - Located in the generator repository

## Relationship with Generator Repository

This configuration repository works in tandem with the **generator repository**:

```
┌─────────────────────────────────────────────────────────────────┐
│ Generator Repository ({{ generator_repo_name }})                │
│                                                                 │
│  • Python scripts for fetching AWS state                       │
│  • Jinja2 templates for generating Terraform code              │
│  • GitHub Actions workflow (runs daily)                        │
│  • Infrastructure module for TFC setup                         │
│                                                                 │
│                    ↓ Generates & Commits ↓                     │
└─────────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────────┐
│ Configuration Repository (THIS REPOSITORY)                      │
│                                                                 │
│  • Generated Terraform configurations                           │
│  • Applied to AWS via Terraform Cloud                          │
│  • Automatically updated daily by generator workflow           │
└─────────────────────────────────────────────────────────────────┘
```

### How It Works

1. **Daily Generation**: The generator repository runs a GitHub Actions workflow daily (weekdays at 8:50 AM MST)
2. **AWS State Capture**: The workflow fetches the current state of all IAM Identity Center resources from AWS
3. **Terraform Generation**: Python scripts transform the AWS state into Terraform HCL using Jinja2 templates
4. **Automatic Commit**: Generated files are committed to this repository
5. **Pull Request**: A pull request is created with the changes for review
6. **Terraform Apply**: After merging, Terraform Cloud applies the configurations to AWS

## ⚠️ Important: Manual Edits Will Be Overwritten

**All files in this repository are auto-generated.** Any manual edits you make will be **overwritten** the next time the generator runs.

### If You Need to Make Changes

**Option 1: Modify AWS Directly (Recommended)**
- Make changes directly in AWS IAM Identity Center console
- The generator will detect the changes on the next run
- Changes will be reflected in the generated Terraform code

**Option 2: Modify Generator Templates**
- If you need to change the structure of generated code, modify the Jinja2 templates in the generator repository
- Templates are located in `templates/` directory of the generator repository

**Option 3: Temporary Manual Edits**
- You can make manual edits for testing or emergency fixes
- Be aware these will be overwritten on the next generator run
- Document your changes so they can be properly implemented

## Deploying Terraform Configurations

### Prerequisites

Before deploying, ensure:

1. ✅ **Infrastructure module deployed** - The generator repository's infrastructure module must be deployed first
2. ✅ **Terraform Cloud workspaces created** - The infrastructure module creates all required workspaces
3. ✅ **OIDC authentication configured** - The infrastructure module sets up AWS authentication
4. ✅ **VCS connection established** - Workspaces are connected to this repository

If you haven't completed these steps, see the [generator repository README](https://github.com/{{ github_owner }}/{{ generator_repo_name }}) for setup instructions.

### Terraform Cloud Workspace Structure

The infrastructure module creates the following workspaces in Terraform Cloud:

| Workspace | Purpose | Dependencies |
|-----------|---------|--------------|
| `{{ workspace_prefix }}-identity-store` | Users, groups, and group memberships | None (independent) |
| `{{ workspace_prefix }}-managed-policies` | AWS managed policies | None (independent) |
| `{{ workspace_prefix }}-permission-sets` | Permission sets with policies | identity-store, managed-policies |
| `{{ workspace_prefix }}-account-assignments` | User/group assignments to accounts | identity-store, permission-sets |
| `{{ workspace_prefix }}-team` | AWS TEAM resources (if enabled) | identity-store, permission-sets |

### Workspace Dependencies

The workspaces have a hierarchical dependency structure:

```
┌─────────────────────┐  ┌─────────────────────┐
│ identity-store      │  │ managed-policies    │
│ (Independent)       │  │ (Independent)       │
└──────────┬──────────┘  └──────────┬──────────┘
           │                        │
           └────────┬───────────────┘
                    │
                    ▼
         ┌─────────────────────┐
         │ permission-sets     │
         │ (Depends on both)   │
         └──────────┬──────────┘
                    │
                    ▼
         ┌─────────────────────┐
         │ account-assignments │
         │ (Depends on above)  │
         └─────────────────────┘
                    │
                    ▼
         ┌─────────────────────┐
         │ team (optional)     │
         │ (Depends on above)  │
         └─────────────────────┘
```

### Deployment Order

**Apply workspaces in this order:**

1. **Phase 1** (Parallel): Apply these workspaces simultaneously
   - `{{ workspace_prefix }}-identity-store`
   - `{{ workspace_prefix }}-managed-policies`

2. **Phase 2**: After Phase 1 completes successfully
   - `{{ workspace_prefix }}-permission-sets`

3. **Phase 3**: After Phase 2 completes successfully
   - `{{ workspace_prefix }}-account-assignments`

4. **Phase 4** (Optional): If TEAM is enabled, after Phase 3 completes
   - `{{ workspace_prefix }}-team`

### Applying via Terraform Cloud UI

1. **Log in to Terraform Cloud**: Navigate to your organization
2. **Select workspace**: Choose the first workspace to apply (e.g., `{{ workspace_prefix }}-identity-store`)
3. **Queue plan**: Click "Actions" → "Start new plan"
4. **Review plan**: Examine the planned changes
5. **Apply**: Click "Confirm & Apply" if changes look correct
6. **Repeat**: Continue with remaining workspaces in dependency order

### Applying via Terraform Cloud CLI

```bash
# Set your Terraform Cloud token
export TF_TOKEN_app_terraform_io="your-tfc-token"

# Phase 1: Apply independent workspaces (can be done in parallel)
cd identity_store
terraform init
terraform plan
terraform apply

cd ../managed_policies
terraform init
terraform plan
terraform apply

# Phase 2: Apply permission-sets (depends on Phase 1)
cd ../permission_sets
terraform init
terraform plan
terraform apply

# Phase 3: Apply account-assignments (depends on Phase 2)
cd ../account_assignments
terraform init
terraform plan
terraform apply

# Phase 4 (Optional): Apply team workspace if enabled
cd ../team
terraform init
terraform plan
terraform apply
```

### Applying via Terraform Cloud API

```bash
# Set variables
TFC_ORG="{{ tfc_organization }}"
TFC_TOKEN="your-tfc-token"

# Function to trigger workspace run
trigger_run() {
  local workspace=$1
  curl \
    --header "Authorization: Bearer $TFC_TOKEN" \
    --header "Content-Type: application/vnd.api+json" \
    --request POST \
    --data "{\"data\":{\"attributes\":{\"message\":\"Triggered via API\"},\"type\":\"runs\",\"relationships\":{\"workspace\":{\"data\":{\"type\":\"workspaces\",\"id\":\"$workspace\"}}}}}" \
    https://app.terraform.io/api/v2/runs
}

# Phase 1: Trigger independent workspaces
trigger_run "{{ workspace_prefix }}-identity-store"
trigger_run "{{ workspace_prefix }}-managed-policies"

# Wait for Phase 1 to complete, then trigger Phase 2
trigger_run "{{ workspace_prefix }}-permission-sets"

# Wait for Phase 2 to complete, then trigger Phase 3
trigger_run "{{ workspace_prefix }}-account-assignments"

# Optional: Wait for Phase 3 to complete, then trigger Phase 4
trigger_run "{{ workspace_prefix }}-team"
```

## Understanding Generated Files

### File Headers

All generated files include a header comment indicating they are auto-generated:

```hcl
# This file is auto-generated by aws-identity-management-generator
# Manual edits will be overwritten on the next generation
# Last generated: 2024-01-15 08:50:00 MST
```

### Provider Configuration

Each workspace subdirectory contains a `providers.tf` file with Terraform Cloud backend configuration:

```hcl
terraform {
  cloud {
    organization = "{{ tfc_organization }}"
    workspaces {
      name = "{{ workspace_prefix }}-identity-store"
    }
  }
  
  required_providers {
    aws = {
      source  = "hashicorp/aws"
      version = "~> 5.0"
    }
  }
}
```

### Remote State Data Sources

Workspaces with dependencies use remote state data sources to reference outputs from other workspaces:

```hcl
# In permission-sets workspace
data "terraform_remote_state" "identity_store" {
  backend = "remote"
  
  config = {
    organization = "{{ tfc_organization }}"
    workspaces = {
      name = "{{ workspace_prefix }}-identity-store"
    }
  }
}
```

### Resource Naming

Resources are named using a consistent pattern:

- **Users**: `aws_identitystore_user.user_<username>`
- **Groups**: `aws_identitystore_group.group_<groupname>`
- **Permission Sets**: `aws_ssoadmin_permission_set.permset_<permissionsetname>`
- **Account Assignments**: `aws_ssoadmin_account_assignment.assignment_<account>_<permset>_<type>_<principal>`

## Importing Existing Resources

If you have existing IAM Identity Center resources that are not yet managed by Terraform, the generator creates import commands for you.

### Import Files

Look for files named `import_commands.sh` in each workspace subdirectory. These contain Terraform import commands for all resources:

```bash
# Example: identity_store/import_commands.sh
terraform import aws_identitystore_user.user_john_doe d-1234567890/12345678-1234-1234-1234-123456789012
terraform import aws_identitystore_group.group_admins d-1234567890/12345678-1234-1234-1234-123456789012
```

### Running Imports

```bash
cd identity_store
chmod +x import_commands.sh
./import_commands.sh
```

**Note**: Import commands are only needed when first adopting existing resources. After the initial import, Terraform will manage the resources going forward.

## Troubleshooting

### "Resource already exists" errors

**Cause**: Resources exist in AWS but not in Terraform state

**Solution**:
1. Use the generated import commands to import existing resources
2. Or delete resources in AWS and let Terraform recreate them

### "Dependency cycle detected" errors

**Cause**: Workspaces applied in wrong order

**Solution**: Apply workspaces in the correct dependency order (see [Deployment Order](#deployment-order))

### "Invalid permission set ARN" errors

**Cause**: Permission set doesn't exist or wrong ARN

**Solution**:
1. Ensure `identity-store` and `permission-sets` workspaces were applied first
2. Verify remote state data sources are configured correctly
3. Check that workspace names match in provider configurations

### "No changes detected" in pull requests

**Cause**: AWS state hasn't changed since last generation

**Solution**: This is normal - no action needed. The generator creates a PR even when there are no changes for audit purposes.

### "Terraform plan fails" after merging PR

**Cause**: Workspace configuration or dependencies issue

**Solution**:
1. Check Terraform Cloud workspace settings
2. Verify VCS connection is working
3. Ensure workspace has correct working directory set
4. Check that remote state data sources reference correct workspace names

## Monitoring and Drift Detection

### Automated Drift Detection

The generator runs automatically on weekdays at 8:50 AM MST. This provides:

- **Daily drift detection**: Catches changes made outside Terraform
- **Automatic reconciliation**: Generates updated Terraform code to match AWS state
- **Pull request workflow**: Changes are reviewed before applying

### Manual Drift Detection

To manually trigger drift detection:

1. Go to the [generator repository](https://github.com/{{ github_owner }}/{{ generator_repo_name }})
2. Navigate to **Actions** tab
3. Select **IAM Identity Center Generator** workflow
4. Click **Run workflow**
5. Choose verbosity level and click **Run workflow**

### Reviewing Changes

When a pull request is created:

1. **Review the diff**: Check what resources changed
2. **Verify against AWS**: Confirm changes match expected AWS state
3. **Check for unexpected changes**: Look for modifications you didn't make
4. **Merge when ready**: Approve and merge the PR
5. **Apply in Terraform Cloud**: Queue plans in the affected workspaces

## Configuration

### Terraform Cloud Organization

This repository is configured to use Terraform Cloud organization: **{{ tfc_organization }}**

If you need to change the organization:
1. Update the generator repository's `config.yaml` file
2. Re-run the generator to update provider configurations
3. Update workspace configurations in Terraform Cloud

### Workspace Naming Pattern

Workspaces follow the naming pattern: `{{ workspace_prefix }}-{component}`

Where `{component}` is one of:
- `identity-store`
- `managed-policies`
- `permission-sets`
- `account-assignments`
- `team` (if enabled)

### AWS Region

IAM Identity Center resources are managed in region: **{{ aws_region }}**

### Feature Flags

- **AWS TEAM Support**: {% if enable_team %}Enabled{% else %}Disabled{% endif %}
- **Auto-update Providers**: {% if auto_update_providers %}Enabled{% else %}Disabled{% endif %}

To change feature flags, update the infrastructure module parameters in the generator repository.

## Getting Help

### Documentation

- **Generator Repository**: [{{ generator_repo_name }}](https://github.com/{{ github_owner }}/{{ generator_repo_name }})
- **Infrastructure Module**: [{{ generator_repo_name }}/infrastructure](https://github.com/{{ github_owner }}/{{ generator_repo_name }}/tree/main/infrastructure)
- **AWS IAM Identity Center**: [AWS Documentation](https://docs.aws.amazon.com/singlesignon/latest/userguide/what-is.html)
- **Terraform Cloud**: [HashiCorp Documentation](https://developer.hashicorp.com/terraform/cloud-docs)

### Common Tasks

**Task**: Update user or group information
- **Solution**: Make changes in AWS IAM Identity Center console, generator will detect on next run

**Task**: Add new permission set
- **Solution**: Create in AWS IAM Identity Center console, generator will detect on next run

**Task**: Modify permission set policies
- **Solution**: Update in AWS IAM Identity Center console, generator will detect on next run

**Task**: Change workspace configuration
- **Solution**: Update infrastructure module parameters in generator repository and re-deploy

**Task**: Disable TEAM support
- **Solution**: Set `enable_team = false` in infrastructure module and re-deploy

**Task**: Change Terraform Cloud organization
- **Solution**: Update `config.yaml` in generator repository and re-run generator

## Repository Maintenance

### Keeping Up to Date

This repository is automatically kept up to date by the generator workflow. No manual maintenance is required.

### Archiving Old Branches

The generator creates a new branch for each run. You may want to periodically clean up old branches:

```bash
# List all remote branches
git branch -r

# Delete old generator branches (older than 30 days)
git branch -r --merged | grep 'generator-' | sed 's/origin\///' | xargs -I {} git push origin --delete {}
```

### Backup and Recovery

**Backup**: This repository is backed up by:
- GitHub's infrastructure (repository history)
- Terraform Cloud state files (resource state)
- AWS IAM Identity Center (source of truth)

**Recovery**: If this repository is lost:
1. Create a new empty repository
2. Trigger the generator workflow in the generator repository
3. The generator will recreate all Terraform files from AWS state

## Security Considerations

### Secrets and Sensitive Data

- ✅ **No secrets in repository**: This repository does not contain any secrets or credentials
- ✅ **No sensitive data**: Generated files do not include sensitive information
- ✅ **OIDC authentication**: Terraform Cloud uses OIDC for AWS authentication (no long-lived credentials)

### Access Control

- **Repository access**: Limit write access to automated workflows and administrators
- **Terraform Cloud access**: Use role-based access control (RBAC) for workspace permissions
- **AWS access**: Follow least-privilege principle for IAM roles

### Audit Trail

- **Git history**: All changes are tracked in Git with commit messages
- **Pull requests**: Changes are reviewed before merging
- **Terraform Cloud runs**: All applies are logged in Terraform Cloud
- **AWS CloudTrail**: All AWS API calls are logged in CloudTrail

## License

This is free and unencumbered software released into the public domain. See [UNLICENSE](UNLICENSE) for details.

---

**Generated by**: [aws-identity-management-generator](https://github.com/{{ github_owner }}/{{ generator_repo_name }})
